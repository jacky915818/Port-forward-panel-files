<!DOCTYPE html>
<html>
<head>
    <title>端口转发管理面板</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* 顶部导航栏 */
        .navbar {
            background: white;
            padding: 0.8rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 99;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        /* 主要内容区域 */
        .main-container {
            display: flex;
            margin-top: 60px;
            padding: 20px;
            gap: 20px;
            min-height: calc(100vh - 60px);
        }

        /* 左侧边栏 */
        .sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        /* 右侧主要内容 */
        .content {
            flex: 1;
            min-width: 0;
        }

        /* 卡片样式 */
        .card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76,175,80,0.1);
        }

        /* 按钮样式 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #43a047;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        /* 状态卡片 */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 150px;
        }

        .status-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .status-card .icon {
            font-size: 20px;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-card .label {
            color: #666;
            font-size: 14px;
        }

        /* 表格样式 */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            display: flex;
            flex-direction: column;
            height: 350px;  /* 固定高度 */
        }

        .chart-header {
            margin-bottom: 15px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: calc(100% - 50px);  /* 减去标题的高度 */
        }

        /* 图表标题样式 */
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1f36;
            margin-bottom: 4px;
        }

        .chart-subtitle {
            font-size: 12px;
            color: #64748b;
        }

        /* 响应式布局 */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-card {
                height: 300px;
            }
        }

        /* 左侧菜单样式 */
        .sidebar-menu {
            width: 200px;
            background: #1a1f36;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            color: white;
            padding-top: 60px;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .sidebar-menu.collapsed {
            width: 60px;
        }

        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            color: #a0aec0;
        }

        .menu-item:hover {
            background: #2d3748;
            color: white;
        }

        .menu-item.active {
            background: #2d3748;
            color: white;
            border-left: 3px solid #4CAF50;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .menu-item span {
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .sidebar-menu.collapsed .menu-item span {
            opacity: 0;
            width: 0;
        }

        /* 主内容区域调整 */
        .main-container {
            margin-left: 200px;
            padding: 70px 20px 20px;
            transition: all 0.3s ease;
        }

        .main-container.expanded {
            margin-left: 60px;
        }

        /* 选项卡样式 */
        .tab-container {
            display: none;
        }

        .tab-container.active {
            display: block;
        }

        /* 修复图表容器高度 */
        .chart-card {
            height: 300px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: #1a1f36;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            background: #f5f5f5;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .navbar-text {
            color: #666;
            font-size: 14px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* 仪表盘卡片布局 */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            padding: 0 25px;  /* 与图表容器对齐 */
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            min-height: 120px;
        }

        .stat-icon {
            width: 60px;  /* 增加图标大小 */
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon i {
            font-size: 28px;  /* 增加图标大小 */
            color: white;
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 28px;  /* 增加数值字体大小 */
            font-weight: 600;
            color: #1a1f36;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .stat-desc {
            font-size: 12px;
            color: #94a3b8;
        }

        /* 图表网格布局 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            height: 300px;
        }

        .chart-header {
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1f36;
            margin-bottom: 4px;
        }

        .chart-subtitle {
            font-size: 12px;
            color: #94a3b8;
        }

        /* 状态卡片样式 */
        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #1a1f36;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
        }

        /* 网络流量卡片特殊样式 */
        .stat-card.network .stat-value {
            font-size: 18px;
        }

        .stat-card.network .stat-value div {
            margin: 3px 0;
        }

        /* 颜色主题 */
        .bg-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .bg-success {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .bg-warning {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .bg-info {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }

        /* 响应式布局 */
        @media (max-width: 1200px) {
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-row {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 仪表盘局样式 */
        #dashboard {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* 状态卡片行 */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            padding: 0 25px;  /* 与图表容器对齐 */
        }

        /* 状态卡片样式 */
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            min-height: 120px;
        }

        /* 图表布局 */
        .metrics-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);  /* 改为4列布局 */
            gap: 25px;
            padding: 0 25px;  /* 与状态卡片对齐 */
        }

        /* 图表卡片式 */
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            height: 350px;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            margin-bottom: 20px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        /* 响应式布局 */
        @media (max-width: 1600px) {
            .stats-row,
            .metrics-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-row,
            .metrics-container {
                grid-template-columns: 1fr;
                padding: 0 15px;  /* 在小屏幕上减小内边距 */
            }
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 60px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            right: 0;
            left: 200px;
            z-index: 1000;
            transition: left 0.3s ease;
        }

        .license-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 14px;
            color: #64748b;
        }

        .license-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .license-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .license-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .license-item i {
            color: #4CAF50;
        }

        /* 当侧边栏收起时调整导航栏 */
        .main-container.expanded .navbar {
            left: 60px;
        }

        /* 端口转发页面样式 */
        .forward-page {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 顶部统计卡片 */
        .forward-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        /* 表单卡片样式 */
        .forward-form-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }

        .forward-form {
            padding: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 列表卡片样式 */
        .forward-list-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 响应式布局 */
        @media (max-width: 1200px) {
            .forward-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .forward-stats {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* 系统设置 */
        .settings-container {
            padding: 25px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 25px;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1f36;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: #4CAF50;
        }

        .settings-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #1a1f36;
            margin-bottom: 8px;
        }

        .input-with-tip {
            position: relative;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76,175,80,0.1);
            outline: none;
        }

        .input-tip {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        /* 开关样式优化 */
        .switch-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .switch-input {
            display: none;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            border-radius: 24px;
            transition: all 0.3s;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .switch-input:checked + .switch-slider {
            background-color: #4CAF50;
        }

        .switch-input:checked + .switch-slider:before {
            transform: translateX(20px);
        }

        .switch-label {
            font-size: 14px;
            color: #1a1f36;
            cursor: pointer;
        }

        /* 阈值设置样式 */
        .threshold-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 8px;
        }

        .threshold-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .threshold-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .threshold-input input {
            width: 80px;
        }

        .unit {
            color: #64748b;
        }

        /* 按钮样式 */
        .form-actions {
            margin-top: 20px;
        }

        .settings-actions {
            text-align: right;
        }

        /* 响应式布局 */
        @media (max-width: 1024px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar">
        <div class="navbar-brand">
            <button id="toggleSidebar" class="btn-icon">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="license-info">
            <div class="license-status">
                <i class="fas fa-key"></i>
                <span id="licenseKey">授权码: </span>
            </div>
            <div class="license-details">
                <div class="license-item">
                    <i class="fas fa-clock"></i>
                    <span id="licenseExpire">到期时间: </span>
                </div>
                <div class="license-item">
                    <i class="fas fa-plug"></i>
                    <span id="portUsage">端口使用: </span>
                </div>
            </div>
        </div>
        <div class="navbar-actions">
            <span class="navbar-text" id="currentTime"></span>
            <button onclick="logout()" class="btn btn-danger btn-sm">
                <i class="fas fa-sign-out-alt"></i> 退出登录
            </button>
        </div>
    </nav>

    <!-- 左侧菜单 -->
    <div class="sidebar-menu">
        <div class="menu-item active" onclick="switchTab('dashboard')">
            <i class="fas fa-tachometer-alt"></i> 仪表盘
        </div>
        <div class="menu-item" onclick="switchTab('forward')">
            <i class="fas fa-random"></i> 端口转发
        </div>
        <div class="menu-item" onclick="switchTab('settings')">
            <i class="fas fa-cog"></i> 系统设置
        </div>
        <div class="menu-item" onclick="loadHelpDocs()">
            <i class="fas fa-question-circle"></i> 帮助文档
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="main-container">
        <!-- 仪表盘 -->
        <div id="dashboard" class="tab-container active">
            <!-- 状态卡片行 -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon bg-primary">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">CPU</div>
                        <div class="stat-value" id="cpuPercent">-</div>
                        <div class="stat-desc">处理器使用率</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-success">
                        <i class="fas fa-memory"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">内存</div>
                        <div class="stat-value" id="memoryPercent">-</div>
                        <div class="stat-desc">内存使用率</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-warning">
                        <i class="fas fa-hdd"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">磁盘</div>
                        <div class="stat-value" id="diskPercent">-</div>
                        <div class="stat-desc">磁盘使用率</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bg-info">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">网络</div>
                        <div class="stat-value">
                            <div>↑ <span id="networkUp">-</span></div>
                            <div>↓ <span id="networkDown">-</span></div>
                        </div>
                        <div class="stat-desc">实时流量</div>
                    </div>
                </div>
            </div>

            <!-- 图表布局 -->
            <div class="metrics-container">
                <!-- CPU 列 -->
                <div class="metric-column">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">CPU 使用趋势</div>
                            <div class="chart-subtitle">实时处理器使用率变化</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="cpuChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 内存列 -->
                <div class="metric-column">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">内存使用情况</div>
                            <div class="chart-subtitle">已用/可用内存分布</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="memoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 磁盘列 -->
                <div class="metric-column">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">磁盘使用情况</div>
                            <div class="chart-subtitle">存储空间使用分布</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="diskChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 网络列 -->
                <div class="metric-column">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">网络流量趋势</div>
                            <div class="chart-subtitle">上传/下载速率变化</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="networkChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 端口转发理 -->
        <div id="forward" class="tab-container">
            <div class="forward-page">
                <!-- 顶部统计卡片 -->
                <div class="forward-stats">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary">
                            <i class="fas fa-network-wired"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">已用端口</div>
                            <div class="stat-value" id="usedPorts">-</div>
                            <div class="stat-desc">当前使用的端口数量</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-success">
                            <i class="fas fa-plug"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">可用端口</div>
                            <div class="stat-value" id="availablePorts">-</div>
                            <div class="stat-desc">剩余可用的端口数量</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-info">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-label">授权到</div>
                            <div class="stat-value" id="licenseExpiry">-</div>
                            <div class="stat-desc">授权码到期时间</div>
                        </div>
                    </div>
                </div>

                <!-- 添加转发表单 -->
                <div class="forward-form-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-plus"></i> 添加端口转发
                        </div>
                    </div>
                    <form id="forwardForm" class="forward-form" onsubmit="return submitForward(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="local_port">本地端口:</label>
                                <input type="number" class="form-control" id="local_port" name="local_port" 
                                       required min="1" max="65535" placeholder="1-65535">
                            </div>
                            <div class="form-group">
                                <label for="target_host">目标地址:</label>
                                <input type="text" class="form-control" id="target_host" name="target_host" 
                                       required placeholder="目标主机地址">
                            </div>
                            <div class="form-group">
                                <label for="target_port">目标端口:</label>
                                <input type="number" class="form-control" id="target_port" name="target_port" 
                                       required min="1" max="65535" placeholder="1-65535">
                            </div>
                            <div class="form-group">
                                <label for="protocol">协议类型:</label>
                                <select class="form-control" id="protocol" name="protocol">
                                    <option value="tcp">TCP (普通)</option>
                                    <option value="https">HTTPS (SSL/TLS)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> 添加转发
                        </button>
                    </form>
                </div>

                <!-- 转发列表 -->
                <div class="forward-list-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-list"></i> 转发列表
                        </div>
                        <div class="header-actions">
                            <button onclick="resetForwards()" class="btn btn-warning">
                                <i class="fas fa-redo"></i> 重置所有转发
                            </button>
                            <button onclick="refreshForwards()" class="btn btn-primary">
                                <i class="fas fa-sync"></i> 刷新列表
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>本地端口</th>
                                    <th>目标地址</th>
                                    <th>目标端口</th>
                                    <th>协议</th>
                                    <th>状态</th>
                                    <th>流量统计</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="forwardsList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统设置 -->
        <div id="settings" class="tab-container">
            <div class="settings-container">
                <div class="settings-grid">
                    <!-- 异常通知设置 -->
                    <div class="settings-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-bell"></i> 异常通知设置
                            </div>
                        </div>
                        <div class="settings-form">
                            <div class="form-group">
                                <div class="switch-wrapper">
                                    <label class="switch">
                                        <input type="checkbox" id="enableNotify" class="switch-input">
                                        <span class="switch-slider"></span>
                                    </label>
                                    <span class="switch-label">启用异常通知</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>接收通知邮箱</label>
                                <div class="input-with-tip">
                                    <input type="email" id="notifyEmail" class="form-control" placeholder="请输入接收通知的邮箱地址">
                                    <div class="input-tip">系统异常时将发送通知到此邮箱</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>通知阈值设置</label>
                                <div class="threshold-grid">
                                    <div class="threshold-item">
                                        <label>CPU使用率超过</label>
                                        <div class="threshold-input">
                                            <input type="number" id="cpuThreshold" class="form-control" min="0" max="100">
                                            <span class="unit">%</span>
                                        </div>
                                    </div>
                                    <div class="threshold-item">
                                        <label>内存使用率超过</label>
                                        <div class="threshold-input">
                                            <input type="number" id="memoryThreshold" class="form-control" min="0" max="100">
                                            <span class="unit">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-tip">系统资源使用超过阈值时发送通知</div>
                            </div>

                            <!-- 测试通知按钮 -->
                            <div class="form-actions">
                                <button class="btn btn-info" onclick="testEmailNotify()">
                                    <i class="fas fa-paper-plane"></i> 发送测试通知
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- API令牌管理 -->
                    <div class="settings-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-key"></i> API令牌管理
                            </div>
                        </div>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>创建新令牌</label>
                                <input type="text" id="tokenDescription" class="form-control" placeholder="令牌描述（用途）">
                                <div class="input-tip">描述这个令牌的用途，方便管理</div>
                            </div>
                            <div class="form-group">
                                <label>有效期</label>
                                <select id="tokenExpires" class="form-control">
                                    <option value="30">30天</option>
                                    <option value="90">90天</option>
                                    <option value="180">180天</option>
                                    <option value="365">365天</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="createApiToken()">
                                <i class="fas fa-plus"></i> 创建令牌
                            </button>
                            
                            <div class="token-list">
                                <h4>现有令牌</h4>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>描述</th>
                                                <th>令牌</th>
                                                <th>创建时间</th>
                                                <th>过期时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tokenList">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 保存按钮 -->
                <div class="settings-actions">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                </div>
            </div>
        </div>

        <!-- 添加帮助文档标签页 -->
        <div id="help" class="tab-container">
            <div class="help-container">
                <!-- 左侧导航 -->
                <div class="help-nav">
                    <div class="nav-group">
                        <div class="nav-title">基础使用</div>
                        <div class="nav-item active" onclick="switchHelpTab('quick-start')">
                            <i class="fas fa-play-circle"></i>
                            <span>快速开始</span>
                        </div>
                        <div class="nav-item" onclick="switchHelpTab('guide')">
                            <i class="fas fa-book"></i>
                            <span>使用指南</span>
                        </div>
                        <div class="nav-item" onclick="switchHelpTab('faq')">
                            <i class="fas fa-question-circle"></i>
                            <span>常见问题</span>
                        </div>
                    </div>
                    
                    <div class="nav-group">
                        <div class="nav-title">开发文档</div>
                        <div class="nav-item" onclick="switchHelpTab('api')">
                            <i class="fas fa-code"></i>
                            <span>API 接口</span>
                        </div>
                        <div class="nav-item" onclick="switchHelpTab('examples')">
                            <i class="fas fa-file-code"></i>
                            <span>示例代码</span>
                        </div>
                    </div>
                </div>

                <!-- 右侧内容 -->
                <div class="help-content">
                    <!-- 快速开始 -->
                    <div id="help-quick-start" class="help-section active">
                        <div class="help-header">
                            <h2><i class="fas fa-play-circle"></i> 快速开始</h2>
                            <p class="help-desc">通过几个简单的步骤，快速了解如何使用端口转发面板</p>
                        </div>
                        <div class="quick-start-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h3>创建端口转发</h3>
                                    <p>在"端口转发"页面填写以下信息：</p>
                                    <ul>
                                        <li><strong>本地端口：</strong>要监听的端口</li>
                                        <li><strong>目标地址：</strong>要转发到的地址</li>
                                        <li><strong>目标端口：</strong>要转发到的端口</li>
                                        <li><strong>协议类型：</strong>TCP或HTTPS</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h3>管理转发</h3>
                                    <p>在转发列表中可以：</p>
                                    <ul>
                                        <li><strong>查看状态：</strong>显示转发是否正在运行</li>
                                        <li><strong>启动/停止：</strong>控制转发状态</li>
                                        <li><strong>查看流量：</strong>监控流量使用情况</li>
                                        <li><strong>删除转发：</strong>移除不需要的转发</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h3>监控系统</h3>
                                    <p>在仪表盘中查看：</p>
                                    <ul>
                                        <li><strong>系统状态：</strong>CPU、内存、磁盘使用率</li>
                                        <li><strong>网络流量：</strong>实时上传下载速度</li>
                                        <li><strong>端口状态：</strong>已用端口和可用端口数量</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API文档 -->
                    <div id="help-api" class="help-section">
                        <div class="help-header">
                            <h2><i class="fas fa-code"></i> API 接口文档</h2>
                            <p class="help-desc">通过API接口实现自动化管理端口转发</p>
                        </div>
                        <div class="api-docs">
                            <div class="doc-section">
                                <h3>认证方式</h3>
                                <div class="info-block">
                                    <p>所有API请求需要在Header中添加令牌：</p>
                                    <div class="code-block">
                                        <div class="code-header">
                                            <span>请求头</span>
                                            <button class="copy-btn" onclick="copyCode(this)">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <pre><code>X-API-Token: your_token_here</code></pre>
                                    </div>
                                </div>
                            </div>

                            <div class="doc-section">
                                <h3>接口列表</h3>
                                <div class="api-list">
                                    <div class="api-item">
                                        <div class="api-header">
                                            <span class="method get">GET</span>
                                            <span class="path">/api/v1/forwards</span>
                                            <span class="desc">获取转发列表</span>
                                        </div>
                                        <div class="api-body">
                                            <div class="code-block">
                                                <div class="code-header">
                                                    <span>响应示例</span>
                                                    <button class="copy-btn" onclick="copyCode(this)">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                <pre><code>{
    "status": "success",
    "data": [
        {
            "local_port": 80,
            "target_host": "example.com",
            "target_port": 80,
            "protocol": "tcp",
            "status": "active"
        }
    ]
}</code></pre>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="api-item">
                                        <div class="api-header">
                                            <span class="method post">POST</span>
                                            <span class="path">/api/v1/forwards</span>
                                            <span class="desc">创建端口转发</span>
                                        </div>
                                        <div class="api-body">
                                            <div class="code-block">
                                                <div class="code-header">
                                                    <span>请求示例</span>
                                                    <button class="copy-btn" onclick="copyCode(this)">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                <pre><code>{
    "local_port": 80,
    "target_host": "example.com",
    "target_port": 80,
    "protocol": "tcp"
}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 示例代码 -->
                    <div id="help-examples" class="help-section">
                        <div class="help-header">
                            <h2><i class="fas fa-file-code"></i> 示例代码</h2>
                            <p class="help-desc">各种编程语言的API调用示例</p>
                        </div>
                        <div class="code-examples">
                            <div class="example-item">
                                <h3>Python</h3>
                                <div class="code-block">
                                    <div class="code-header">
                                        <span>完整示例</span>
                                        <button class="copy-btn" onclick="copyCode(this)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <pre><code>import requests

api_token = 'your_token_here'
headers = {'X-API-Token': api_token}

# 获取转发列表
response = requests.get('http://your-server:5000/api/v1/forwards', 
                       headers=headers)
print(response.json())

# 创建转发
data = {
    'local_port': 80,
    'target_host': 'example.com',
    'target_port': 80,
    'protocol': 'tcp'
}
response = requests.post('http://your-server:5000/api/v1/forwards', 
                        headers=headers, json=data)
print(response.json())</code></pre>
                                </div>
                            </div>

                            <div class="example-item">
                                <h3>Shell</h3>
                                <div class="code-block">
                                    <div class="code-header">
                                        <span>完整示例</span>
                                        <button class="copy-btn" onclick="copyCode(this)">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <pre><code># 获取转发列表
curl -H "X-API-Token: your_token_here" \
     http://your-server:5000/api/v1/forwards

# 创建转发
curl -X POST \
     -H "X-API-Token: your_token_here" \
     -H "Content-Type: application/json" \
     -d '{"local_port":80,"target_host":"example.com","target_port":80}' \
     http://your-server:5000/api/v1/forwards</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加选项卡切换和时间显示的脚本 -->
    <script>
    // 图表配置和数据
    let charts = {};

    const chartColors = {
        primary: '#4CAF50',
        secondary: '#2196F3',
        warning: '#FFC107',
        danger: '#F44336'
    };

    // 添加一个变量来控制是否更新系统状态
    let systemStatusInterval = null;

    // 初始化图表
    function initCharts() {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 10,
                        usePointStyle: true,
                        boxWidth: 8,
                        font: {
                            size: 11
                        }
                    }
                }
            }
        };

        // CPU用率图表 - 折线图
        charts.cpu = new Chart(document.getElementById('cpuChart'), {
            type: 'line',
            data: {
                labels: Array(10).fill(''),
                datasets: [{
                    label: 'CPU使用率',
                    data: Array(10).fill(0),
                    borderColor: chartColors.primary,
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: value => value + '%'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // 内存使用率图表 - 环形
        charts.memory = new Chart(document.getElementById('memoryChart'), {
            type: 'doughnut',
            data: {
                labels: ['已用', '可用'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: [chartColors.warning, chartColors.primary],
                    borderWidth: 0
                }]
            },
            options: {
                ...commonOptions,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            usePointStyle: true,
                            boxWidth: 8
                        }
                    }
                }
            }
        });

        // 网络流量图表 - 双折线图
        charts.network = new Chart(document.getElementById('networkChart'), {
            type: 'line',
            data: {
                labels: Array(10).fill(''),
                datasets: [{
                    label: '上传',
                    data: Array(10).fill(0),
                    borderColor: chartColors.primary,
                    tension: 0.4,
                    fill: false
                }, {
                    label: '下载',
                    data: Array(10).fill(0),
                    borderColor: chartColors.secondary,
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => formatBytes(value)
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // 磁盘用率图表 - 饼
        charts.disk = new Chart(document.getElementById('diskChart'), {
            type: 'doughnut',
            data: {
                labels: ['已用', '可用'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: [chartColors.warning, chartColors.primary],
                    borderWidth: 0
                }]
            },
            options: {
                ...commonOptions,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            usePointStyle: true,
                            boxWidth: 8
                        }
                    }
                }
            }
        });
    }

    // 添加字节格化数
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 更新图表数据
    function updateCharts(data) {
        console.log('Updating charts with data:', data);  // 添加调试日志
        
        try {
            if (charts.cpu) {
                charts.cpu.data.datasets[0].data.push(data.cpu.percent);
                charts.cpu.data.datasets[0].data.shift();
                charts.cpu.update();
            }

            if (charts.memory) {
                charts.memory.data.datasets[0].data = [
                    data.memory.percent,
                    100 - data.memory.percent
                ];
                charts.memory.update();
            }

            if (charts.disk) {
                charts.disk.data.datasets[0].data = [
                    data.disk.percent,
                    100 - data.disk.percent
                ];
                charts.disk.update();
            }

            if (charts.network) {
                const sent = parseFloat(data.network.bytes_sent);
                const recv = parseFloat(data.network.bytes_recv);
                charts.network.data.datasets[0].data.push(sent);
                charts.network.data.datasets[0].data.shift();
                charts.network.data.datasets[1].data.push(recv);
                charts.network.data.datasets[1].data.shift();
                charts.network.update();
            }
        } catch (error) {
            console.error('Error updating charts:', error);
        }
    }

    // 更新系统状态
    function updateSystemStatus() {
        console.log('Fetching system status...');
        
        fetch('/system_status')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        // 会话过期，重定向到登录页面
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'error') {
                    throw new Error(data.message);
                }
                
                if (data.status === 'success' && data.data) {
                    // 更新状态卡片
                    const cpuElement = document.getElementById('cpuPercent');
                    const memoryElement = document.getElementById('memoryPercent');
                    const diskElement = document.getElementById('diskPercent');
                    const networkUpElement = document.getElementById('networkUp');
                    const networkDownElement = document.getElementById('networkDown');

                    if (cpuElement) cpuElement.textContent = `${data.data.cpu.percent}%`;
                    if (memoryElement) memoryElement.textContent = `${data.data.memory.percent}%`;
                    if (diskElement) diskElement.textContent = `${data.data.disk.percent}%`;
                    if (networkUpElement) networkUpElement.textContent = data.data.network.bytes_sent;
                    if (networkDownElement) networkDownElement.textContent = data.data.network.bytes_recv;
                    
                    // 更新图表
                    updateCharts(data.data);
                }
            })
            .catch(error => {
                console.error('Error fetching system status:', error);
                // 如果发生错误，停止更新定时器
                if (systemStatusInterval) {
                    clearInterval(systemStatusInterval);
                    systemStatusInterval = null;
                }
            });
    }

    // 修改初始化代码
    document.addEventListener('DOMContentLoaded', function() {
        // 获取当前显示的标签页
        const currentTab = document.querySelector('.tab-container.active');
        if (currentTab && currentTab.id === 'dashboard') {
            // 如果当前是仪表盘，初始化并开始更新
            initCharts();
            updateSystemStatus(); // 立即更新一次
            
            // 如果已经有定时器，先清除
            if (systemStatusInterval) {
                clearInterval(systemStatusInterval);
            }
            // 设置新的定时器
            systemStatusInterval = setInterval(updateSystemStatus, 3000);
        }
        
        // 更新授权信息
        updateLicenseInfo();
        // 更新转发列表
        refreshForwards();
    });

    // 加侧边栏切换功能
    document.getElementById('toggleSidebar').addEventListener('click', function() {
        const sidebar = document.querySelector('.sidebar-menu');
        const mainContainer = document.querySelector('.main-container');
        
        sidebar.classList.toggle('collapsed');
        mainContainer.classList.toggle('expanded');
    });

    // 在小屏幕下自动折叠侧边栏
    function checkScreenSize() {
        const sidebar = document.querySelector('.sidebar-menu');
        const mainContainer = document.querySelector('.main-container');
        
        if (window.innerWidth < 768) {
            sidebar.classList.add('collapsed');
            mainContainer.classList.add('expanded');
        } else {
            sidebar.classList.remove('collapsed');
            mainContainer.classList.remove('expanded');
        }
    }

    // 监听窗口大小变化
    window.addEventListener('resize', checkScreenSize);
    // 页面加载时检查
    document.addEventListener('DOMContentLoaded', checkScreenSize);

    // 添加选项卡切换功能
    function switchTab(tabId) {
        // 先清除所有定时器
        if (systemStatusInterval) {
            clearInterval(systemStatusInterval);
            systemStatusInterval = null;
        }
        
        // 隐藏所有标签页
        document.querySelectorAll('.tab-container').forEach(tab => {
            tab.style.display = 'none';
        });
        
        // 移除所有激活状态
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // 显示选中的标签页
        document.getElementById(tabId).style.display = 'block';
        document.querySelector(`.menu-item[onclick="switchTab('${tabId}')"]`).classList.add('active');
        
        // 如果切换到仪表盘，初始化并开始更新
        if (tabId === 'dashboard') {
            // 销毁已存在的图表
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });
            // 初始化新图表
            initCharts();
            // 立即更新一次
            updateSystemStatus();
            // 开始定更新
            systemStatusInterval = setInterval(updateSystemStatus, 3000);
        }
        
        // 如果切换到端口转发页面，刷新转发列表
        if (tabId === 'forward') {
            refreshForwards();
            updateLicenseInfo();
        }
    }

    // 退出登录
    function logout() {
        Swal.fire({
            title: '确认退出',
            text: '确定要退出登录吗？',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '确定出',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/logout', {
                    method: 'POST'
                }).then(() => {
                    window.location.href = '/login';
                });
            }
        });
    }

    // 获取授权信息并更新显示
    function updateLicenseInfo() {
        fetch('/license_info')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    throw new Error(data.message);
                }
                
                // 更新端口转发页面的统计信息
                document.getElementById('usedPorts').textContent = data.used_ports;
                document.getElementById('availablePorts').textContent = 
                    data.port_limit === -1 ? '不限' : (data.port_limit - data.used_ports);
                document.getElementById('licenseExpiry').textContent = data.expires_at;
                
                // 更新顶部导航栏的授权信息
                document.getElementById('licenseKey').textContent = 
                    `授权码: ${data.license_key.substring(0, 8)}****`;
                document.getElementById('licenseExpire').textContent = 
                    `到期时间: ${data.expires_at}`;
                document.getElementById('portUsage').textContent = 
                    `端口使用: ${data.used_ports}/${data.port_limit === -1 ? '不限' : data.port_limit}`;
            })
            .catch(error => {
                console.error('获取授权信息失败:', error);
                // 显示错误信息
                document.getElementById('usedPorts').textContent = '-';
                document.getElementById('availablePorts').textContent = '-';
                document.getElementById('licenseExpiry').textContent = '-';
            });
    }

    // 保存设置
    function saveSettings() {
        const settings = {
            enableNotify: document.getElementById('enableNotify')?.checked || false,
            notifyEmail: document.getElementById('notifyEmail')?.value || '',
            cpuThreshold: parseInt(document.getElementById('cpuThreshold')?.value || '80'),
            memoryThreshold: parseInt(document.getElementById('memoryThreshold')?.value || '80')
        };

        // 验证设置
        if (settings.enableNotify && !settings.notifyEmail) {
            Swal.fire({
                icon: 'warning',
                title: '请填写接收通知的邮箱',
                text: '启用异常通知时必须填写接收通知的邮箱地址'
            });
            return;
        }

        fetch('/save_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '保存成功',
                    text: '设置已更新',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.message || '存���败');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: '保存失败',
                text: error.message || '保存设置失败，请重试'
            });
        });
    }

    // 发送测试通知
    function testEmailNotify() {
        const email = document.getElementById('notifyEmail').value;
        if (!email) {
            Swal.fire({
                icon: 'warning',
                title: '请填写接收通知的邮箱',
                text: '请先填写接收通知的邮箱地址'
            });
            return;
        }

        // 显示加载状态
        Swal.fire({
            title: '发送中...',
            text: '正在发送测试通知',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('/test_email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '发送成功',
                    text: '测试通知已发送，请查收邮件',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.message || '发送失败');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: '发送失败',
                text: error.message || '发送测试通知失败'
            });
        });
    }

    // 在页面加载时获取设置
    document.addEventListener('DOMContentLoaded', function() {
        // 获取当前设置
        fetch('/get_settings')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 只设置异常通知相关的设置
                    const enableNotify = document.getElementById('enableNotify');
                    const notifyEmail = document.getElementById('notifyEmail');
                    const cpuThreshold = document.getElementById('cpuThreshold');
                    const memoryThreshold = document.getElementById('memoryThreshold');

                    if (enableNotify) enableNotify.checked = data.data.enableNotify;
                    if (notifyEmail) notifyEmail.value = data.data.notifyEmail;
                    if (cpuThreshold) cpuThreshold.value = data.data.cpuThreshold;
                    if (memoryThreshold) memoryThreshold.value = data.data.memoryThreshold;
                }
            })
            .catch(error => {
                console.error('获取设置失败:', error);
                // 不显示错误提示，因为这不是关键功能
            });
    });

    // 添加转发函数
    function submitForward(event) {
        event.preventDefault();
        
        const formData = new FormData();
        formData.append('local_port', document.getElementById('local_port').value);
        formData.append('target_host', document.getElementById('target_host').value);
        formData.append('target_port', document.getElementById('target_port').value);
        formData.append('protocol', document.getElementById('protocol').value);
        
        // 显示加载状态
        Swal.fire({
            title: '正在添加...',
            text: '请稍候',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // 发送请求
        fetch('/setup_forward', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络请失败');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '添加成功',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    document.getElementById('forwardForm').reset();
                    refreshForwards();
                    updateLicenseInfo();  // 更新授权信息
                });
            } else {
                throw new Error(data.message || '添加失败');
            }
        })
        .catch(error => {
            console.error('添加失败:', error);
            Swal.fire({
                icon: 'error',
                title: '添加失败',
                text: error.message || '添加转发失败，请重试'
            });
        });

        return false;
    }

    // 重置转发函数
    function resetForwards() {
        Swal.fire({
            title: '确认重置',
            text: '确定要重置所有端口转发吗？此操作将删除所有转发配置！',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '确定重置',
            cancelButtonText: '取消',
            confirmButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: '正在重置...',
                    text: '请稍候',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                fetch('/reset_forwards', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    // 即使请求失败也继续处理
                    return response.text().then(text => {
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            // 如果不是JSON，检查是否实际上重置成功
                            return { status: 'success', message: '重置完成' };
                        }
                    });
                })
                .then(() => {
                    // 无论如何都刷新状态
                    return Promise.all([
                        fetch('/license_info').then(res => res.json()),
                        fetch('/get_forwards').then(res => res.json())
                    ]);
                })
                .then(([licenseData, forwardsData]) => {
                    // 更新授权信息显示
                    if (licenseData.status === 'success') {
                        document.getElementById('usedPorts').textContent = licenseData.used_ports;
                        document.getElementById('availablePorts').textContent = 
                            licenseData.port_limit === -1 ? '不限' : (licenseData.port_limit - licenseData.used_ports);
                        document.getElementById('portUsage').textContent = 
                            `端口使用: ${licenseData.used_ports}/${licenseData.port_limit === -1 ? '不限' : licenseData.port_limit}`;
                    }
                    
                    // 更新转发列表
                    if (forwardsData.status === 'success') {
                        const tbody = document.getElementById('forwardsList');
                        tbody.innerHTML = '';
                        forwardsData.forwards.forEach(forward => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${forward.local_port}</td>
                                <td>${forward.target_host}</td>
                                <td>${forward.target_port}</td>
                                <td>${forward.protocol}</td>
                                <td>
                                    <span class="status-badge ${forward.status}">
                                        ${forward.status === 'active' ? '运行中' : '已停止'}
                                    </span>
                                </td>
                                <td class="traffic-stats" data-port="${forward.local_port}">
                                    <div>↑ <span class="bytes-sent">-</span></div>
                                    <div>↓ <span class="bytes-received">-</span></div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteForward(${forward.local_port})">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                    ${forward.status === 'active' ? 
                                        `<button class="btn btn-sm btn-warning" onclick="stopForward(${forward.local_port})">
                                            <i class="fas fa-stop"></i> 停止
                                        </button>` :
                                        `<button class="btn btn-sm btn-success" onclick="startForward(${forward.local_port})">
                                            <i class="fas fa-play"></i> 启动
                                        </button>`
                                    }
                                </td>
                            `;
                            tbody.appendChild(tr);
                            
                            // 获取该端口的流量统计
                            updatePortTraffic(forward.local_port);
                        });
                    }
                    
                    // 显示成功消息
                    Swal.fire({
                        icon: 'success',
                        title: '重置成功',
                        text: '所有端口转发已重置',
                        timer: 2000,
                        showConfirmButton: false
                    });
                })
                .catch(error => {
                    console.error('Reset error:', error);
                    // 检查是否实际上重置成功
                    refreshForwards();
                    updateLicenseInfo();
                    
                    // 显示一个较温和的提示
                    Swal.fire({
                        icon: 'info',
                        title: '操作完成',
                        text: '重置操作可能已完成，请检查转发列表',
                        timer: 2000,
                        showConfirmButton: false
                    });
                });
            }
        });
    }

    // 刷新转发列表
    function refreshForwards() {
        fetch('/get_forwards')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const tbody = document.getElementById('forwardsList');
                    if (!tbody) {
                        console.error('找不到转发列表容器');
                        return;
                    }
                    tbody.innerHTML = '';
                    
                    data.forwards.forEach(forward => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${forward.local_port}</td>
                            <td>${forward.target_host}</td>
                            <td>${forward.target_port}</td>
                            <td>${forward.protocol}</td>
                            <td>
                                <span class="status-badge ${forward.status}">
                                    ${forward.status === 'active' ? '运行中' : '已停止'}
                                </span>
                            </td>
                            <td class="traffic-stats" data-port="${forward.local_port}">
                                <div>↑ <span class="bytes-sent">-</span></div>
                                <div>↓ <span class="bytes-received">-</span></div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteForward(${forward.local_port})">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                                ${forward.status === 'active' ? 
                                    `<button class="btn btn-sm btn-warning" onclick="stopForward(${forward.local_port})">
                                        <i class="fas fa-stop"></i> 停止
                                    </button>` :
                                    `<button class="btn btn-sm btn-success" onclick="startForward(${forward.local_port})">
                                        <i class="fas fa-play"></i> 启动
                                    </button>`
                                }
                            </td>
                        `;
                        tbody.appendChild(tr);
                        
                        // 获取该端口的流量统计
                        updatePortTraffic(forward.local_port);
                    });
                } else {
                    console.error('获取转发列表失败:', data.message);
                }
            })
            .catch(error => {
                console.error('获取转发列表失败:', error);
            });
    }

    // 在页面加载时获取转发列表
    document.addEventListener('DOMContentLoaded', function() {
        refreshForwards();
        // 每30秒刷新一次
        setInterval(refreshForwards, 30000);
    });

    // 删除转发
    function deleteForward(port) {
        Swal.fire({
            title: '确认删除',
            text: `确定要删除端口 ${port} 的转发吗？`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '确定删除',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('local_port', port);
                
                fetch('/delete_forward', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: '删除成功',
                            text: data.message,
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            refreshForwards();
                            updateLicenseInfo();
                        });
                    } else {
                        throw new Error(data.message || '删除失败');
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: '删除失败',
                        text: error.message
                    });
                });
            }
        });
    }

    // 停��转发
    function stopForward(port) {
        const formData = new FormData();
        formData.append('local_port', port);
        
        fetch('/stop_forward', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '停止成功',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    refreshForwards();
                });
            } else {
                throw new Error(data.message || '停止失败');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: '停止失败',
                text: error.message
            });
        });
    }

    // 启动转发
    function startForward(port) {
        const formData = new FormData();
        formData.append('local_port', port);
        
        fetch('/start_forward', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '启动成功',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    refreshForwards();
                });
            } else {
                throw new Error(data.message || '启动失败');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: '启动失败',
                text: error.message
            });
        });
    }

    // 添加更新端口流量的函数
    function updatePortTraffic(port) {
        fetch(`/port_traffic/${port}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const trafficCell = document.querySelector(`.traffic-stats[data-port="${port}"]`);
                    if (trafficCell) {
                        trafficCell.querySelector('.bytes-sent').textContent = formatBytes(data.data.bytes_sent);
                        trafficCell.querySelector('.bytes-received').textContent = formatBytes(data.data.bytes_received);
                    }
                }
            })
            .catch(error => console.error(`获取端口 ${port} 流量失败:`, error));
    }

    // 创建API令牌
    function createApiToken() {
        const description = document.getElementById('tokenDescription').value;
        const expires = document.getElementById('tokenExpires').value;
        
        if (!description) {
            Swal.fire({
                icon: 'warning',
                title: '请输入令牌描述',
                text: '描述用于标识令牌的用途'
            });
            return;
        }
        
        const formData = new FormData();
        formData.append('description', description);
        formData.append('expires_days', expires);
        
        fetch('/api/token', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // 保存成功后显示令牌
                Swal.fire({
                    icon: 'success',
                    title: '创建成功',
                    html: `
                        <div style="text-align: left;">
                            <p>请保存以下信息：</p>
                            <p>令牌：<code>${data.token}</code></p>
                            <p class="text-warning">注意：令牌只显示一次，请妥善保管！</p>
                        </div>
                    `,
                    confirmButtonText: '复制令牌',
                    showCancelButton: true,
                    cancelButtonText: '关闭'
                }).then((result) => {
                    if (result.isConfirmed) {
                        navigator.clipboard.writeText(data.token);
                        Swal.fire({
                            icon: 'success',
                            title: '已复制',
                            text: '令牌已复制到剪贴板',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
                
                // 清空输入框并刷新列表
                document.getElementById('tokenDescription').value = '';
                refreshTokenList();
            } else {
                throw new Error(data.message || '创建失败');
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: '创建失败',
                text: error.message
            });
        });
    }

    // 刷新令牌列表
    function refreshTokenList() {
        fetch('/api/tokens')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const tbody = document.getElementById('tokenList');
                    tbody.innerHTML = '';
                    
                    data.tokens.forEach(token => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${token.description}</td>
                            <td>${token.token.substring(0, 8)}****</td>
                            <td>${new Date(token.created_at).toLocaleString()}</td>
                            <td>${new Date(token.expires_at).toLocaleString()}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="revokeToken('${token.token}')">
                                    <i class="fas fa-trash"></i> 撤销
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            })
            .catch(error => {
                console.error('获取令牌列表失败:', error);
            });
    }

    // 在页面加载时刷新令牌列表
    document.addEventListener('DOMContentLoaded', function() {
        refreshTokenList();
    });

    // 添加加载帮助文档的JavaScript函数
    function loadHelpDocs() {
        // 在新窗口打开帮助文档
        window.open('/help', '_blank');
    }
    </script>
</body>
</html> 